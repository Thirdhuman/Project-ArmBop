---
title: "R Notebook"
---
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.
```{r}
library(ggmap)
library(tidyverse)
library(data.table)

myAgg <- function (formula, data, FUN, ..., subset, na.action = na.omit) 
{
  if (missing(formula) || !inherits(formula, "formula")) 
    stop("'formula' missing or incorrect")
  if (length(formula) != 3L) 
    stop("'formula' must have both left and right hand sides")
  m <- match.call(expand.dots = FALSE)
  if (is.matrix(eval(m$data, parent.frame()))) 
    m$data <- as.data.frame(data)
  m$... <- m$FUN <- NULL
  m[[1L]] <- as.name("model.frame")
  if (formula[[2L]] == ".") {
    rhs <- unlist(strsplit(deparse(formula[[3L]]), " *[:+] *"))
    lhs <- sprintf("cbind(%s)", paste(setdiff(names(data), 
                                              rhs), collapse = ","))
    lhs
    m[[2L]][[2L]] <- parse(text = lhs)[[1L]]
  }
  mf <- eval(m, parent.frame())
  if (is.matrix(mf[[1L]])) {
    lhs <- as.data.frame(mf[[1L]])
    names(lhs) <- as.character(m[[2L]][[2L]])[-1L]
    myOut <- aggregate.data.frame(lhs, mf[-1L], FUN = FUN, ...)
    colnames(myOut) <- c(names(mf[-1L]), 
                         paste(names(lhs), deparse(substitute(FUN)), sep = "."))
  }
  else {
    myOut <- aggregate.data.frame(mf[1L], mf[-1L], FUN = FUN, ...)
    colnames(myOut) <- c(names(mf[-1L]), 
                         paste(strsplit(gsub("cbind\\(|\\)|\\s", "", 
                                             names(mf[1L])), ",")[[1]],
                               deparse(substitute(FUN)), sep = "."))
  } 
  myOut
}

```

```{r}
setwd("~/PythonStuff/Project-ArmBop/Robert/Data/")

flight_dt=read_csv('Merged_Flights.csv')
keys=read_csv('Keys.csv')
Ccodes=read_csv('Carrier Code.csv')

Ccodes=subset(Ccodes, is.na(End))
coordinates=read_csv('city_coordinates.csv')
flight_dt=setDT(flight_dt)
```

```{r}
names(flight_dt)=tolower(names(flight_dt))
names(flight_dt)
flight_dt$x22 = NULL
company = subset(Ccodes, select = c(Code,Name))
#unique(flight_dt$origin_city_name)
```



```{r}
flight_dt=merge(flight_dt, coordinates, by.x = 'dest_city_name', by.y = 'city_name')
names(flight_dt)[names(flight_dt) == 'lat'] = 'dest_lat'
names(flight_dt)[names(flight_dt) == 'lon'] = 'dest_lon'
flight_dt$X1 = NULL

flight_dt=merge(flight_dt, coordinates, by.x = 'origin_city_name', by.y = 'city_name')
names(flight_dt)[names(flight_dt) == 'lat'] = 'origin_lat'
names(flight_dt)[names(flight_dt) == 'lon'] = 'origin_lon'
flight_dt$X1 = NULL
flight_dt = subset(flight_dt, origin_city_name!= 'Pago Pago, TT' & dest_city_name!= 'Pago Pago, TT')
flight_dt = subset(flight_dt, origin_city_name!= 'Guam, TT' & dest_city_name!= 'Guam, TT')
flight_dt = subset(flight_dt, origin_city_name!= 'Ponce, PR' & dest_city_name!= 'Ponce, PR')
flight_dt=subset(flight_dt,origin_city_name!='Charlotte Amalie, VI'&dest_city_name!='Charlotte Amalie, VI')
flight_dt = subset(flight_dt, origin_city_name!= 'Aguadilla, PR' & dest_city_name!= 'Aguadilla, PR')
flight_dt = subset(flight_dt, origin_city_name!= 'San Juan, PR' & dest_city_name!= 'San Juan, PR')
flight_dt= subset(flight_dt, origin_city_name!='Christiansted, VI'&dest_city_name!='Christiansted, VI')

flight_dt$one = 1
```

```{r}
names(flight_dt)
head(flight_dt)
```

```{r}
# Destination / Origin

flight_dt_most_dest=myAgg(one ~ dest_city_name+dest_lon+dest_lat, flight_dt, sum)
names(flight_dt_most_dest)[names(flight_dt_most_dest) == 'one.sum'] <- 'dest.sum'
#flight_dt_most_dest

flight_dt_most_origin=myAgg(one ~ origin_city_name, flight_dt, sum)
names(flight_dt_most_origin)[names(flight_dt_most_origin) == 'one.sum'] <- 'origin.sum'
#flight_dt_most_origin

flight_dt_most=merge(flight_dt_most_dest, flight_dt_most_origin, by.x = 'dest_city_name', by.y = 'origin_city_name', all = T)
names(flight_dt_most)[names(flight_dt_most) == 'dest_city_name'] <- 'city_name'
names(flight_dt_most)[names(flight_dt_most) == 'dest_lon'] <- 'lon'
names(flight_dt_most)[names(flight_dt_most) == 'dest_lat'] <- 'lat'

flight_dt_most

write.csv(flight_dt_most,'map_app/www/flight_dt_most.csv')

```

```{r}



names(flight_dt)
head(flight_dt)

```


```{r}
names(flight_dt)
head(flight_dt)
drops <- c("dest_lon","dest_lat", 'origin_lat', 'origin_lon', 'late_aircraft_delay', 'security_delay','nas_delay','carrier_delay','dest','origin', 'year','month', 'weather_delay','div_airport_landings','day_of_month')


flight_df=as.data.frame(flight_dt)
tiny_flights=flight_df[ , !(names(flight_df) %in% drops)]
tiny_flights=merge(tiny_flights, company, by.x = "carrier", by.y = "Code", all.x = T)
names(tiny_flights)
str(tiny_flights)

delayed_flights=aggregate(one ~ dest_city_name+dest_lon+dest_lat, flight_dt, sum)

delayed_flights=aggregate(one ~ dest_city_name+dest_lon+dest_lat, flight_dt, sum)
#merge(flight_dt)

delayed_flights


```

